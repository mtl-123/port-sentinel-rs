# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# netpulse-rs - Build & Release Static Binary (x86-64 Only)
# ç‰¹æ€§ï¼šRust musl é™æ€ç¼–è¯‘ | UPX å‹ç¼©éªŒè¯ | è‡ªåŠ¨ Release å‘å¸ƒ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Build & Release Static Binary

on:
  push:
    branches:
      - master
    tags:
      - "v*"
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  BIN_NAME: net_monitor
  PROJECT_NAME: netpulse-rs
  RUST_VERSION: "stable"
  TARGET_ARCH: x86_64-unknown-linux-musl

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆä»… PR æˆ–é Tag æ¨é€æ—¶è¿è¡Œï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Code Quality Check
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' || (!startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy
          target: ${{ env.TARGET_ARCH }}

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run Tests
        run: cargo test --verbose

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # æ„å»º Linux x86_64 é™æ€äºŒè¿›åˆ¶ï¼ˆæ ¸å¿ƒä»»åŠ¡ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-linux-x86_64-static:
    name: Build Linux x86_64 Static
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    needs:
      - lint
    if: |
      always() &&
      (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && needs.lint.result == 'success') ||
        (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
        (github.event_name == 'push' && github.ref == 'refs/heads/master')
      )

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rust-src
          target: ${{ env.TARGET_ARCH }}

      - name: Cache Cargo Dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          shared-key: musl-build

      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt update -y || true
          sudo apt install -y --no-install-recommends \
            build-essential \
            musl-tools \
            musl-dev \
            gh \
            file \
            upx-ucl \
            bc \
            patchelf
          echo "âœ… System dependencies installed"
          musl-gcc --version
          upx --version || echo "UPX not available"

      - name: Configure Cargo for Static Build
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "musl-gcc"
          rustflags = ["-C", "target-feature=+crt-static", "-C", "strip=symbols"]
          EOF
          echo "âœ… Cargo configuration created"
          cat .cargo/config.toml

      - name: Build Static Binary
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/${{ env.TARGET_ARCH }}/release/${BIN_NAME}"

          echo "=== å¼€å§‹ç¼–è¯‘ ==="
          echo "Binary: ${BIN_NAME}"
          echo "Target: ${{ env.TARGET_ARCH }}"
          echo "Expected path: ${BIN_PATH}"

          cargo build \
            --target ${{ env.TARGET_ARCH }} \
            --release \
            --verbose

          echo "=== ç¼–è¯‘å®Œæˆï¼ŒéªŒè¯äº§ç‰© ==="
          ls -la "target/${{ env.TARGET_ARCH }}/release/"

          if [ ! -f "$BIN_PATH" ]; then
            echo "âŒ FATAL: Binary not found at ${BIN_PATH}"
            exit 1
          fi

          echo "=== æ–‡ä»¶ä¿¡æ¯ ==="
          file "$BIN_PATH"

          if file "$BIN_PATH" | grep -qi "statically linked"; then
            echo "âœ… ç¡®è®¤ä¸ºé™æ€é“¾æ¥äºŒè¿›åˆ¶"
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ° statically linked æ ‡è®°"
          fi

          ORIG_SIZE=$(du -b "$BIN_PATH" | awk '{print $1}')
          echo "original_size=${ORIG_SIZE}" >> $GITHUB_ENV
          echo "âœ… Binary size: ${ORIG_SIZE} bytes"

      - name: Verify Original Binary
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/${{ env.TARGET_ARCH }}/release/${BIN_NAME}"
          TIMEOUT_SEC=10

          chmod +x "$BIN_PATH"
          echo "=== æµ‹è¯•åŸå§‹äºŒè¿›åˆ¶å¯æ‰§è¡Œæ€§ ==="

          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1; then
            echo "âœ… --version æ£€æµ‹é€šè¿‡"
          elif timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1; then
            echo "âœ… -h æ£€æµ‹é€šè¿‡"
          elif timeout ${TIMEOUT_SEC}s "$BIN_PATH" --help >/dev/null 2>&1; then
            echo "âœ… --help æ£€æµ‹é€šè¿‡"
          else
            echo "âš ï¸ æ— æ ‡å‡†å‚æ•°å“åº”ï¼ˆå¯èƒ½æ˜¯äº¤äº’å¼ç¨‹åºï¼‰"
            echo "âœ… æ–‡ä»¶å­˜åœ¨ä¸”å¯æ‰§è¡Œï¼Œè§†ä¸ºæœ‰æ•ˆ"
          fi

          echo "=== åŠ¨æ€åº“ä¾èµ–æ£€æŸ¥ ==="
          ldd "$BIN_PATH" 2>&1 | head -5 || echo "é™æ€é“¾æ¥ï¼ˆæ— åŠ¨æ€åº“ä¾èµ–ï¼‰"

      - name: Compress with UPX
        id: upx_compress
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="target/${{ env.TARGET_ARCH }}/release/${BIN_NAME}"

          mkdir -p bin
          cp "$BIN_PATH" "bin/${BIN_NAME}"
          cp "bin/${BIN_NAME}" "bin/${BIN_NAME}.backup"

          echo "=== UPX å‹ç¼©å‰ ==="
          ls -lh "bin/${BIN_NAME}"
          ORIG_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')

          if upx --best --lzma --force --strip-relocs=0 -q "bin/${BIN_NAME}" 2>/dev/null; then
            echo "âœ… UPX å‹ç¼©æˆåŠŸ"

            echo "=== UPX å‹ç¼©åéªŒè¯ ==="
            ls -lh "bin/${BIN_NAME}"
            COMP_SIZE=$(du -b "bin/${BIN_NAME}" | awk '{print $1}')

            if [ "$ORIG_SIZE" -gt 0 ]; then
              COMP_RATIO=$(echo "scale=2; $COMP_SIZE * 100 / $ORIG_SIZE" | bc)
              SAVED_RATIO=$(echo "scale=2; 100 - $COMP_RATIO" | bc)
              echo "ğŸ“Š å‹ç¼©ç‡ï¼š${SAVED_RATIO}% (${ORIG_SIZE} â†’ ${COMP_SIZE} bytes)"
            fi

            if "bin/${BIN_NAME}" --version >/dev/null 2>&1 || \
               "bin/${BIN_NAME}" -h >/dev/null 2>&1; then
              echo "âœ… å‹ç¼©åäºŒè¿›åˆ¶éªŒè¯é€šè¿‡"
              echo "compressed=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ å‹ç¼©åéªŒè¯å¤±è´¥ï¼Œå›æ»šåˆ°åŸå§‹äºŒè¿›åˆ¶"
              cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
              echo "compressed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ UPX å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹äºŒè¿›åˆ¶"
            cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
            echo "compressed=false" >> $GITHUB_OUTPUT
          fi
          rm -f "bin/${BIN_NAME}.backup"

      - name: Verify Compressed Binary
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          BIN_PATH="bin/${BIN_NAME}"
          TIMEOUT_SEC=10

          chmod +x "$BIN_PATH"
          echo "=== æœ€ç»ˆäºŒè¿›åˆ¶éªŒè¯ ==="
          file "$BIN_PATH"
          ldd "$BIN_PATH" 2>&1 | head -5 || echo "é™æ€é“¾æ¥"

          if timeout ${TIMEOUT_SEC}s "$BIN_PATH" --version >/dev/null 2>&1 || \
             timeout ${TIMEOUT_SEC}s "$BIN_PATH" -h >/dev/null 2>&1; then
            echo "âœ… æœ€ç»ˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ€§éªŒè¯é€šè¿‡"
          else
            echo "âš ï¸ æœ€ç»ˆäºŒè¿›åˆ¶éªŒè¯è­¦å‘Šï¼ˆå¯èƒ½æ˜¯äº¤äº’å¼ç¨‹åºï¼‰"
          fi

      - name: Package Artifacts
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="${{ env.BIN_NAME }}"

          echo "=== æ‰“åŒ…äº§ç‰© ==="

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_TYPE="release"
          else
            SHORT_SHA="${{ github.sha }}"
            SHORT_SHA="${SHORT_SHA:0:8}"
            VERSION="dev-${SHORT_SHA}"
            RELEASE_TYPE="dev"
          fi
          echo "Version: ${VERSION} (${RELEASE_TYPE})"

          if [ "${{ steps.upx_compress.outputs.compressed }}" == "true" ]; then
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static-upx"
          else
            FINAL_BIN="${BIN_NAME}-${VERSION}-linux-x86_64-static"
          fi
          echo "Final binary name: ${FINAL_BIN}"

          cp "bin/${BIN_NAME}" "release/${FINAL_BIN}"
          chmod +x "release/${FINAL_BIN}"
          sha256sum "release/${FINAL_BIN}" | awk '{print $1 "  " $2}' > "release/${FINAL_BIN}.sha256"

          echo "=== æœ€ç»ˆäº§ç‰©ä¿¡æ¯ ==="
          ls -lh release/
          file "release/${FINAL_BIN}"
          cat "release/${FINAL_BIN}.sha256"

          echo "final_bin=release/${FINAL_BIN}" >> $GITHUB_OUTPUT
          echo "final_sum=release/${FINAL_BIN}.sha256" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT
          echo "is_tag=${{ startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v') }}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-linux-x86_64-static-${{ steps.package.outputs.version }}
          path: release/
          retention-days: 30
          if-no-files-found: error

      - name: Debug Release Conditions
        if: always()
        run: |
          echo "=== Release å‘å¸ƒæ¡ä»¶è°ƒè¯• ==="
          echo "github.ref: ${{ github.ref }}"
          echo "github.ref_name: ${{ github.ref_name }}"
          echo "startsWith(github.ref, 'refs/tags/'): ${{ startsWith(github.ref, 'refs/tags/') }}"
          echo "startsWith(github.ref_name, 'v'): ${{ startsWith(github.ref_name, 'v') }}"
          echo "is_tag output: ${{ steps.package.outputs.is_tag }}"
          echo "final_bin: ${{ steps.package.outputs.final_bin }}"
          echo "final_sum: ${{ steps.package.outputs.final_sum }}"

          if [ -f "${{ steps.package.outputs.final_bin }}" ]; then
            echo "âœ… Binary file exists"
            ls -lh "${{ steps.package.outputs.final_bin }}"
          else
            echo "âŒ Binary file NOT found"
          fi

      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/') && startsWith(github.ref_name, 'v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: |
            ## ğŸ“¦ netpulse-rs ${{ github.ref_name }}

            ### ç‰¹æ€§
            - âœ… Linux x86_64 é™æ€äºŒè¿›åˆ¶ï¼ˆmuslï¼‰
            - âœ… UPX å‹ç¼©ä¼˜åŒ–ï¼ˆå¦‚é€‚ç”¨ï¼‰
            - âœ… SHA256 æ ¡éªŒå’ŒéªŒè¯
            - âœ… 7Ã—24 å°æ—¶ç½‘ç»œè¿é€šæ€§ç›‘æ§

            ### ç³»ç»Ÿè¦æ±‚
            - Linux x86_64 (amd64)
            - æ— éœ€é¢å¤–ä¾èµ–ï¼ˆå®Œå…¨é™æ€é“¾æ¥ï¼‰

            ### å¿«é€Ÿä½¿ç”¨
            ```bash
            # ä¸‹è½½
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.package.outputs.final_bin }}

            # éªŒè¯
            sha256sum -c ${{ steps.package.outputs.final_bin }}.sha256

            # æ‰§è¡Œ
            chmod +x ${{ steps.package.outputs.final_bin }}
            ./${{ steps.package.outputs.final_bin }}
            ```

            ### é…ç½®æ–‡ä»¶
            åˆ›å»º `config.toml` æ–‡ä»¶ï¼Œå‚è€ƒé¡¹ç›®ä»“åº“ä¸­çš„é…ç½®ç¤ºä¾‹ã€‚
        run: |
          set -euo pipefail
          echo "=== å¼€å§‹å‘å¸ƒåˆ° GitHub Releases ==="
          echo "Tag: ${{ github.ref_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Binary path: ${{ steps.package.outputs.final_bin }}"
          echo "Checksum path: ${{ steps.package.outputs.final_sum }}"

          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          if [ ! -f "${{ steps.package.outputs.final_bin }}" ]; then
            echo "âŒ ERROR: Binary file missing at ${{ steps.package.outputs.final_bin }}"
            ls -lh release/ || true
            exit 1
          fi
          if [ ! -f "${{ steps.package.outputs.final_sum }}" ]; then
            echo "âŒ ERROR: Checksum file missing at ${{ steps.package.outputs.final_sum }}"
            exit 1
          fi

          echo "=== æ£€æŸ¥ç°æœ‰ Release ==="
          if gh release view ${{ github.ref_name }} --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "âš ï¸ å‘ç°ç°æœ‰ Releaseï¼Œåˆ é™¤åé‡å»º"
            gh release delete ${{ github.ref_name }} --repo ${{ github.repository }} --yes || true
          else
            echo "âœ… æ— ç°æœ‰ Releaseï¼Œç›´æ¥åˆ›å»º"
          fi

          echo "=== åˆ›å»º Release ==="
          gh release create ${{ github.ref_name }} \
            --repo ${{ github.repository }} \
            --title "Release ${{ github.ref_name }} ğŸš€" \
            --notes "${{ env.RELEASE_NOTES }}" \
            --draft=false \
            --prerelease=false \
            "${{ steps.package.outputs.final_bin }}" \
            "${{ steps.package.outputs.final_sum }}"

          echo "=== å‘å¸ƒéªŒè¯ ==="
          if gh release view ${{ github.ref_name }} --repo ${{ github.repository }} --json assets --jq '.assets | length' | grep -q '[1-9]'; then
            echo "âœ… Release published successfully!"
            echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
            gh release view ${{ github.ref_name }} --repo ${{ github.repository }} --json assets --jq '.assets[] | {name, size, downloadUrl}'
          else
            echo "âŒ Release published but assets missing!"
            exit 1
          fi
