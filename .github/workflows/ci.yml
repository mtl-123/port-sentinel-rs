# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# netpulse-rs - Build & Release Static Binary (x86_64 Linux musl)
# ä¿®å¤é‡ç‚¹ï¼šmusl å·¥å…·é“¾ | é™æ€é“¾æ¥éªŒè¯ | å…¼å®¹ UPX | è°ƒè¯•å¢å¼º
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Build & Release Static Binary

on:
  push:
    branches: ["master", "main"]
    tags: ["v*"]
  pull_request:
    branches: ["master", "main"]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  # ğŸ”§ å…³é”®ï¼šBIN_NAME å¿…é¡»ä¸ Cargo.toml ä¸­ [[bin]] name æˆ– package.name ä¸€è‡´
  BIN_NAME: netpulse-rs
  PROJECT_NAME: netpulse-rs
  RUST_VERSION: "1.75.0" # ğŸ”§ å›ºå®šç‰ˆæœ¬é¿å…å…¼å®¹é—®é¢˜
  TARGET: x86_64-unknown-linux-musl

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆPR æˆ–é Tag æ¨é€æ—¶è¿è¡Œï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Code Quality
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' || (!startsWith(github.ref, 'refs/tags/'))
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy
          targets: ${{ env.TARGET }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Clippy & Test
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
          cargo test --verbose

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # æ„å»ºé™æ€äºŒè¿›åˆ¶ï¼ˆæ ¸å¿ƒä»»åŠ¡ï¼‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-static:
    name: Build Linux x86_64 musl Static
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    needs: [lint]
    if: |
      always() &&
      (
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'pull_request' && needs.lint.result == 'success') ||
        (github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/master'))
      )

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ”§ ä¿®å¤ 1: æ­£ç¡®å®‰è£… Rust + musl target
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rust-src
          targets: ${{ env.TARGET }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          key: build-${{ runner.os }}-${{ env.TARGET }}-${{ hashFiles('**/Cargo.lock') }}
          shared-key: musl-static

      # ğŸ”§ ä¿®å¤ 2: å®‰è£… musl å·¥å…·é“¾ + éªŒè¯
      - name: Install System Dependencies
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            musl-tools \
            musl-dev \
            llvm \
            lld \
            upx-ucl \
            file \
            bc \
            patchelf

          # éªŒè¯ musl ç¯å¢ƒ
          echo "=== musl ç¯å¢ƒéªŒè¯ ==="
          which musl-gcc && musl-gcc --version
          rustup target list --installed | grep musl
          echo "âœ… musl ç¯å¢ƒå°±ç»ª"

      # ğŸ”§ ä¿®å¤ 3: ä½¿ç”¨æ›´å…¼å®¹çš„ cargo é…ç½®ï¼ˆé¿å… strip=symbols å…¼å®¹æ€§é—®é¢˜ï¼‰
      - name: Configure Cargo for musl Static Build
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.x86_64-unknown-linux-musl]
          linker = "musl-gcc"
          rustflags = [
            "-C", "target-feature=+crt-static",
            "-C", "link-arg=-s"  # ä½¿ç”¨é“¾æ¥å™¨å‚æ•° stripï¼Œå…¼å®¹æ€§æ›´å¥½
          ]

          # å¦‚æœä½¿ç”¨ openssl/ring ç­‰ crateï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
          # [env]
          # OPENSSL_STATIC = "1"
          # RING_USE_CC = "musl-gcc"
          EOF
          cat .cargo/config.toml

      # ğŸ”§ ä¿®å¤ 4: é¢„ç¼–è¯‘ä¾èµ–ï¼ˆé¿å… musl ä¸‹ç¼–è¯‘å¤±è´¥ï¼‰
      - name: Build Dependencies First
        run: |
          cargo build \
            --target ${{ env.TARGET }} \
            --release \
            --locked \
            --verbose \
            --bins

      # ğŸ”§ ä¿®å¤ 5: æ­£å¼æ„å»º + è¯¦ç»†éªŒè¯
      - name: Build Release Binary
        id: build
        run: |
          set -euo pipefail

          BIN_NAME="${{ env.BIN_NAME }}"
          TARGET="${{ env.TARGET }}"
          BIN_PATH="target/${TARGET}/release/${BIN_NAME}"

          echo "=== æ„å»ºå‚æ•° ==="
          echo "BIN_NAME: ${BIN_NAME}"
          echo "TARGET: ${TARGET}"
          echo "Expected path: ${BIN_PATH}"
          echo "Cargo.toml package name:"
          grep '^name' Cargo.toml | head -1

          echo "=== å¼€å§‹ç¼–è¯‘ ==="
          cargo build \
            --target "${TARGET}" \
            --release \
            --locked \
            --verbose

          echo "=== éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ ==="
          if [ ! -f "${BIN_PATH}" ]; then
            echo "âŒ FATAL: Binary not found!"
            echo "Searching for binaries in target/${TARGET}/release/:"
            find "target/${TARGET}/release/" -maxdepth 1 -type f -executable -ls 2>/dev/null || true
            exit 1
          fi

          echo "âœ… Binary found: ${BIN_PATH}"
          ls -lh "${BIN_PATH}"
          file "${BIN_PATH}"

          # æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€é“¾æ¥
          if file "${BIN_PATH}" | grep -q "statically linked"; then
            echo "âœ… ç¡®è®¤ä¸ºé™æ€é“¾æ¥äºŒè¿›åˆ¶"
            echo "static_linked=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ è­¦å‘Š: æœªæ£€æµ‹åˆ° statically linked"
            echo "ldd è¾“å‡º:"
            ldd "${BIN_PATH}" 2>&1 | head -10 || echo "(ldd å¯èƒ½ä¸é€‚ç”¨äº musl äºŒè¿›åˆ¶)"
            echo "static_linked=false" >> $GITHUB_OUTPUT
          fi

          # è®°å½•æ–‡ä»¶å¤§å°
          ORIG_SIZE=$(stat -c%s "${BIN_PATH}" 2>/dev/null || stat -f%z "${BIN_PATH}")
          echo "original_size=${ORIG_SIZE}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Original size: ${ORIG_SIZE} bytes ($(numfmt --to=iec-i --suffix=B ${ORIG_SIZE} 2>/dev/null || echo "${ORIG_SIZE}B"))"

      # ğŸ”§ ä¿®å¤ 6: æ›´å¥å£®çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ€§æµ‹è¯•
      - name: Test Binary Executability
        run: |
          set -euo pipefail
          BIN_PATH="target/${{ env.TARGET }}/release/${{ env.BIN_NAME }}"
          chmod +x "${BIN_PATH}"

          echo "=== äºŒè¿›åˆ¶åŸºç¡€æµ‹è¯• ==="
          # æµ‹è¯• 1: æ–‡ä»¶ç±»å‹
          file "${BIN_PATH}"

          # æµ‹è¯• 2: å°è¯•æ‰§è¡Œï¼ˆå¸¦è¶…æ—¶ï¼Œé¿å…é˜»å¡ï¼‰
          # å…¼å®¹: --version / -V / --help / -h / æ— å‚æ•°é€€å‡ºç 
          set +e
          timeout 5s "${BIN_PATH}" --version >/dev/null 2>&1 && echo "âœ… --version OK" && exit 0
          timeout 5s "${BIN_PATH}" -V >/dev/null 2>&1 && echo "âœ… -V OK" && exit 0
          timeout 5s "${BIN_PATH}" --help >/dev/null 2>&1 && echo "âœ… --help OK" && exit 0
          timeout 5s "${BIN_PATH}" -h >/dev/null 2>&1 && echo "âœ… -h OK" && exit 0
          # å¦‚æœç¨‹åºæ˜¯äº¤äº’å¼æˆ–æ— å‚æ•°å¯åŠ¨ï¼Œæ£€æŸ¥é€€å‡ºç ï¼ˆ0 æˆ– 1 éƒ½ç®—æ­£å¸¸ï¼‰
          timeout 3s "${BIN_PATH}" >/dev/null 2>&1
          EXIT_CODE=$?
          if [ $EXIT_CODE -le 1 ]; then
            echo "âœ… æ— å‚æ•°æ‰§è¡Œæ­£å¸¸ (exit code: ${EXIT_CODE})"
          else
            echo "âš ï¸ æ— å‚æ•°æ‰§è¡Œé€€å‡ºç : ${EXIT_CODE}ï¼ˆå¯èƒ½æ˜¯é¢„æœŸè¡Œä¸ºï¼‰"
          fi
          set -e

          echo "âœ… äºŒè¿›åˆ¶å¯æ‰§è¡Œæ€§éªŒè¯é€šè¿‡"

      # ğŸ”§ ä¿®å¤ 7: UPX å‹ç¼©ï¼ˆå¯é€‰ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»šï¼‰
      - name: Compress with UPX (Optional)
        id: upx
        if: always() && steps.build.outcome == 'success'
        continue-on-error: true
        run: |
          set -euo pipefail
          BIN_NAME="${{ env.BIN_NAME }}"
          TARGET="${{ env.TARGET }}"
          SRC_PATH="target/${TARGET}/release/${BIN_NAME}"

          mkdir -p bin
          cp "${SRC_PATH}" "bin/${BIN_NAME}"
          cp "bin/${BIN_NAME}" "bin/${BIN_NAME}.backup"

          echo "=== UPX å‹ç¼©å°è¯• ==="
          ORIG_SIZE=$(stat -c%s "bin/${BIN_NAME}" 2>/dev/null || stat -f%z "bin/${BIN_NAME}")

          # å°è¯•å‹ç¼©ï¼Œä½¿ç”¨æ›´å…¼å®¹çš„å‚æ•°
          if upx --best --lzma --force --strip-relocs=0 "bin/${BIN_NAME}" 2>&1; then
            echo "âœ… UPX å‹ç¼©æˆåŠŸ"
            NEW_SIZE=$(stat -c%s "bin/${BIN_NAME}" 2>/dev/null || stat -f%z "bin/${BIN_NAME}")
            RATIO=$(echo "scale=1; (1 - ${NEW_SIZE}/${ORIG_SIZE}) * 100" | bc)
            echo "ğŸ“Š å‹ç¼©ç‡: ${RATIO}% (${ORIG_SIZE} â†’ ${NEW_SIZE} bytes)"

            # éªŒè¯å‹ç¼©åæ˜¯å¦å¯æ‰§è¡Œ
            if timeout 3s "bin/${BIN_NAME}" --version >/dev/null 2>&1 || \
               timeout 3s "bin/${BIN_NAME}" --help >/dev/null 2>&1 || \
               timeout 2s "bin/${BIN_NAME}" >/dev/null 2>&1; then
              echo "âœ… å‹ç¼©åäºŒè¿›åˆ¶éªŒè¯é€šè¿‡"
              echo "compressed=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ å‹ç¼©åéªŒè¯å¤±è´¥ï¼Œå›æ»š"
              cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
              echo "compressed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ UPX å‹ç¼©å¤±è´¥æˆ–ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸå§‹äºŒè¿›åˆ¶"
            cp "bin/${BIN_NAME}.backup" "bin/${BIN_NAME}"
            echo "compressed=false" >> $GITHUB_OUTPUT
          fi
          rm -f "bin/${BIN_NAME}.backup"

      # ğŸ”§ ä¿®å¤ 8: æ‰“åŒ…äº§ç‰©ï¼ˆæ™ºèƒ½å‘½å + SHA256ï¼‰
      - name: Package Release Artifacts
        id: package
        run: |
          set -euo pipefail
          mkdir -p release
          BIN_NAME="${{ env.BIN_NAME }}"

          # ç¡®å®šç‰ˆæœ¬å·å’Œå‘å¸ƒç±»å‹
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_TYPE="release"
          else
            SHORT_SHA="${{ github.sha }}"
            SHORT_SHA="${SHORT_SHA:0:8}"
            VERSION="dev-${SHORT_SHA}"
            RELEASE_TYPE="dev"
          fi

          # ç¡®å®šæ–‡ä»¶å
          if [[ "${{ steps.upx.outputs.compressed }}" == "true" ]]; then
            FINAL_NAME="${BIN_NAME}-${VERSION}-linux-x86_64-musl-upx"
          else
            FINAL_NAME="${BIN_NAME}-${VERSION}-linux-x86_64-musl"
          fi

          cp "bin/${BIN_NAME}" "release/${FINAL_NAME}"
          chmod +x "release/${FINAL_NAME}"

          # ç”Ÿæˆ SHA256
          (cd release && sha256sum "${FINAL_NAME}" > "${FINAL_NAME}.sha256")

          echo "=== æ‰“åŒ…å®Œæˆ ==="
          ls -lh release/
          file "release/${FINAL_NAME}"
          cat "release/${FINAL_NAME}.sha256"

          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "artifact_name=${FINAL_NAME}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT
          echo "is_official_release=${{ startsWith(github.ref, 'refs/tags/v') }}" >> $GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ steps.package.outputs.version }}-linux-x86_64-musl
          path: release/
          retention-days: 30
          if-no-files-found: error

      # ğŸ”§ ä¿®å¤ 9: æ¡ä»¶å‘å¸ƒåˆ° GitHub Releasesï¼ˆä»… Tag è§¦å‘ï¼‰
      - name: Publish to GitHub Releases
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          ARTIFACT="release/${{ steps.package.outputs.artifact_name }}"
          CHECKSUM="release/${{ steps.package.outputs.artifact_name }}.sha256"

          echo "=== å‘å¸ƒåˆ° GitHub Releases ==="
          echo "Tag: ${TAG}"
          echo "Repo: ${REPO}"
          echo "Artifact: ${ARTIFACT}"

          # ç™»å½• gh CLI
          echo "${GITHUB_TOKEN}" | gh auth login --with-token

          # æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„ Releaseï¼ˆé¿å…å†²çªï¼‰
          if gh release view "${TAG}" --repo "${REPO}" &>/dev/null; then
            echo "âš ï¸ å‘ç°ç°æœ‰ Releaseï¼Œåˆ é™¤åé‡å»º"
            gh release delete "${TAG}" --repo "${REPO}" --yes --cleanup-tag || true
          fi

          # åˆ›å»º Release
          gh release create "${TAG}" \
            --repo "${REPO}" \
            --title "ğŸš€ ${PROJECT_NAME} ${TAG}" \
            --notes "## ${PROJECT_NAME} ${TAG}

          ### âœ… ç‰¹æ€§
          - Linux x86_64 é™æ€äºŒè¿›åˆ¶ (musl libc)
          - é›¶å¤–éƒ¨ä¾èµ–ï¼Œå•æ–‡ä»¶éƒ¨ç½²
          - UPX å‹ç¼©ä¼˜åŒ–ï¼ˆå¦‚é€‚ç”¨ï¼‰
          - SHA256 æ ¡éªŒå’ŒéªŒè¯

          ### ğŸ“¦ ä¸‹è½½
          \`\`\`bash
          # ä¸‹è½½äºŒè¿›åˆ¶
          wget https://github.com/${REPO}/releases/download/${TAG}/${{ steps.package.outputs.artifact_name }}

          # éªŒè¯å®Œæ•´æ€§
          wget https://github.com/${REPO}/releases/download/${TAG}/${{ steps.package.outputs.artifact_name }}.sha256
          sha256sum -c ${{ steps.package.outputs.artifact_name }}.sha256

          # æ‰§è¡Œ
          chmod +x ${{ steps.package.outputs.artifact_name }}
          ./${{ steps.package.outputs.artifact_name }}
          \`\`\`

          ### âš™ï¸ é…ç½®
          åˆ›å»º \`config.toml\` æ–‡ä»¶ï¼Œå‚è€ƒä»“åº“ä¸­çš„é…ç½®ç¤ºä¾‹ã€‚
          " \
            --draft=false \
            --prerelease=false \
            "${ARTIFACT}" \
            "${CHECKSUM}"

          echo "âœ… Release published: https://github.com/${REPO}/releases/tag/${TAG}"
